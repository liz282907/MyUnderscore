<!DOCTYPE html>
<html>

<head>
    <title>underscore test helper</title>
</head>

<body>
</body>
<script type="text/javascript">

const isTypeof = (type)=>{
	return (obj)=>{
		const types = type.split("||");
		return types.some(type=>{
			const reg = new RegExp(`function\\s+(${type}).*`)
			let objType;
			if(obj===null) objType = 'null'
			else if(typeof(obj)==='undefined') objType = 'undefined'
			else{
				if(type==='Function') return typeof(obj)==='function'
				if(type==='Object') return typeof(obj)==='object'

				if(obj.constructor===undefined) return false; //x由Object.create(null),且要检验是否为自定义类型
				const matchArr = obj.constructor.toString().match(reg)
				if(!matchArr) return false 
				objType = matchArr[1]
			}
			// if(type==='Function') return objType===type && typeof(obj)==='function'//应对Object.create(Function.prototype)
			return objType===type 
		})		
	}
}


const _ = {}
_.shuffle = (obj)=>{
	let arr = Array.isArray(obj)?[].concat(obj): Object.keys(obj).map(v=>obj[v]);

	const len = arr.length;
	for(let i=0;i<len-1;i++){
		const randomIndex = Math.floor(Math.random()* (len-i-1)) + (i+1);    
		swap(arr,i,randomIndex);
	}
	return arr;

	function swap(nums,i,j){
		let temp = nums[j];
		nums[j] = nums[i];
		nums[i] = temp; 
	}
}
_.range = (...args)=>{
	let start = 0,stop,step = 1,len = args.length,result = [];
	if(len===0) return;
	if(len==1) stop = args[0];
	else if(len===2) [start,stop] = args;
	else if(len>=3) [start,stop,step] = args.slice(0,3);
	
	if(stop<start && step>0) return [];

	if(step>0)
		for(let i=start;i<stop;i+=step) result.push(i);
	else{
		for(let i=start;i>stop;i+=step) result.push(i);
	}
	return result;
}
const numbers = _.range(20);
const shuffled = _.shuffle(numbers)
console.log('----');

_.each = (...args) => {

    let [list, iteratee, context] = args;
    if(!list) return list;     //pass掉诸如非object的比如false,undefined

    if (context) iteratee = iteratee.bind(context);

    const nativeForEach = Array.prototype.forEach;

    const isObject = isTypeof('Object'),
        len = list.length;

    const keys = Object.keys(list);

    if(len===+len){ //鸭子类型的，有length属性的当成数组考虑
    	if (nativeForEach) {
            nativeForEach.call(list, iteratee);
            return list;
        }
        for (let i = 0; i < len; i++) {
            iteratee(list[i], i, list);
        }
    }else{
    	for (let i = 0; i < len; i++) { //要用常数缓存，防止在多次迭代中有可能len变化
            iteratee(list[keys[i]], keys[i],i, list);
        }
    }
    return list; //返回list以便链式调用
}



const answers = [],
                  obj = { one: 1, two: 2, three: 3 };
obj.constructor.prototype.four = 4;
_.each(obj, function(value, key) { answers.push(key); });
                console.log(answers, ['one', 'two', 'three'], 'iterating over objects works, and ignores the object prototype.');


</script>

</html>
